<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>F-A Coutu_FOMO</title>
<style>
   body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #433d69;
      padding: 10px;
      margin-left: 5%;
      margin-right: 5%;
   }

   h1 {
      /*font-size: variable !important;*/
      font-size: 2.3vw;
      font-weight: bold;
      text-align: center; /* Centre le texte */
      color: Grey;
      margin: 0;
      padding: 0;
      border: none;
      white-space: nowrap; /* Empêche le retour à la ligne */
      max-width: 100%; /* Assure que le texte occupe toute la largeur */
      overflow: hidden;
   }

   .titre-1 {
       margin-bottom: 4px;
   }

   .video-container {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 2000px;
      aspect-ratio: 16 / 9;
   }

   iframe {
      width: 100%;
      height: 100%;
   }
   
   #video {
        visibility: hidden;
    }

   .cover {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: transparent;
        z-index: 10; /* Devant la vidéo */
        display: flex;
        justify-content: center;
        align-items: center;
	transition: opacity 0.8s, background-color 1s;
    }
   
   .cover img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        cursor: pointer;
    }

    .btn-video {
      position: absolute;
      top: 10px;  /* Déplace le bouton en haut de la vidéo */
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      width: 240px;
      height: 34px;
      border: none;
      border-radius: 3px;
      overflow: hidden;
      cursor: pointer;
      opacity: 0.8;
      transition: opacity 0.2s, background-color 0.3s;
      z-index: 20; /* Le bouton doit être au-dessus de la vidéo */
      font-size: 12px;
      font-weight: bold;
      text-align: center;
      background-color: transparent;
      visibility: hidden;  /* Commence caché */
   }
   
   .btn-video.visible {
    visibility: visible !important;  /* Assure que le bouton est visible même en plein écran */
    z-index: 20;  /* S'assure que le bouton soit devant tout autre élément */
}

   .btn-video:hover {
      opacity: 1;
   }
   
   .btn-section {
      flex: 1;
      display: flex;
      width: 120px;
      height: 28px;
      align-items: center;
      justify-content: center;
      opacity: 0.8;
      border-radius: 3px;
      transition: background-color 0.3s;
      color: Black;
   }
   .btn-section.left {
      margin-right: 28px; /* Ajoute un espace entre les deux sections */
   }
   .btn-salle1 .left {
      background-color: grey;
      /*color: Black;*/
   }
   .btn-salle1 .right {
      background-color: #433d69;
      /*color: Black;*/
   }
   .btn-salle2 .left {
      background-color: #433d69;
      /*color: Black;*/
   }
   .btn-salle2 .right {
      background-color: grey;
      /*color: Black;*/
   }
</style>
</head>
<body>

<h1 class="titre-1">Appuyer sur le bouton pour faire basculer le son entre Salle 1 et Salle 2</h1>

<div class="video-container">
    <div class="cover" id="cover">
        <img src="https://www.dropbox.com/scl/fi/tjyl8sp1x4vylslec80l2/Capture-d-ecran-le-2025-03-15-20.32.38-2.jpg?rlkey=rlz3oio1ic79yagjsbqcouy3z&st=imua5657&raw=1" alt="Cover" id="coverImage" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;">
    </div>
   <iframe id="video" 
      src="https://www.youtube.com/embed/fm00cFcoJM8?enablejsapi=1&modestbranding=1&rel=0&showinfo=0" 
      frameborder="0"
      allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen">
   </iframe>

   <button id="btnBascule" class="btn-video btn-salle1">
      <div class="btn-section left">Audio Salle 1</div>
      <div class="btn-section right">off</div>
   </button>
</div>

<audio id="audioSalle1" loop>
   <source src="https://www.dropbox.com/scl/fi/ur8dl9pxqmyqqcgq63a2l/FOMO_Audio_Perfo-res-Bain-Mathieu_DRUM.mp3?rlkey=oendf779ij0ijz57i5z65vb8h&st=wya35hdc&raw=1" type="audio/mp3">
</audio>

<audio id="audioSalle2" loop>
   <source src="https://www.dropbox.com/scl/fi/vxsx4wc0ojrao15vsi3rd/FOMO_Audio_Perfo-res-Bain-Mathieu_INSTALL.mp3?rlkey=yuieg0gk2a5t0b6kquxjgoav4&st=15anchfs&raw=1" type="audio/mp3">
</audio>
 
<script>
   
    document.getElementById("coverImage").onload = function() {
        document.getElementById("video").style.visibility = "visible";
        document.getElementById("btnBascule").classList.add("visible");  // Ajoute la classe visible au bouton
    };
    
    document.getElementById("coverImage").addEventListener("click", function() {
	player.playVideo(); // Démarre la vidéo
	setTimeout(() => {
            document.getElementById("cover").style.display = "none"; // Cache l'image
	}, 200);
    });
 
    var audioSalle1 = document.getElementById("audioSalle1");
    var audioSalle2 = document.getElementById("audioSalle2");
    var btnBascule = document.getElementById("btnBascule");
    var player;
    var audioActif = audioSalle1;
    btnBascule.classList.add("btn-salle1");
    var isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
  
    let lastVideoTime = 0;
    let syncCalled = false;
    let offsetMs = 650;
    let offsetBoutonMs = 450;
    let offsetReadyMs = 250;

    if (isSafari) {
    	offsetMs += 300;
    	offsetBoutonMs += 200;
    	offsetReadyMs += 200;
    }

    // Désactiver le bouton au départ
    btnBascule.disabled = true;

    function onYouTubeIframeAPIReady() {
        player = new YT.Player('video', {
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    function catchWhenReady(audioElement, callback) {
        if (audioElement.readyState >= 3) { // HAVE_FUTURE_DATA (compatible Safari/Firefox)
            callback();
        } else {
            audioElement.addEventListener("loadedmetadata", function onLoaded() {
                audioElement.removeEventListener("loadedmetadata", onLoaded);
                callback();
            });
        }
    }

    function onPlayerReady(event) {
        console.log("Le lecteur YouTube est prêt !");
        document.addEventListener("click", function enableAudio() {
            // Assurez-vous que l'audio commence après un clic utilisateur
            audioSalle1.play().catch(e => console.log("Audio bloqué:", e));
            audioSalle2.play().catch(e => console.log("Audio bloqué:", e));
    
            setTimeout(function() {
                catchWhenReady(audioActif, function() {
                    var videoTime = player.getCurrentTime();
                    var adjustedVideoTime = (videoTime * 1000 + offsetReadyMs) / 1000;
                    setTimeout(() => {
                        audioSalle1.currentTime = adjustedVideoTime;
                        audioSalle2.currentTime = adjustedVideoTime;
                    }, 200);
                });
            }, 1000);
            document.removeEventListener("click", enableAudio); // Désactive l'écouteur après la lecture
        });
    }

    function onPlayerStateChange(event) {
        if (event.data == YT.PlayerState.PLAYING && !syncCalled) {
	    syncAudio();
            syncCalled = true;
	    btnBascule.disabled = false; // Activer le bouton
        } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
            stopSync();
            syncCalled = false;
	    //À voir, désactiver la fonction catchWhenReady ici
            catchWhenReady(audioActif, function() {
                var videoTime = player.getCurrentTime();
                var adjustedVideoTime = (videoTime * 1000 + offsetMs) / 1000;
                setTimeout(() => {
                    audioSalle1.currentTime = adjustedVideoTime;
                    audioSalle2.currentTime = adjustedVideoTime;
                }, 200);
            });
	    btnBascule.disabled = true; // Désactiver le bouton
        }
    }

    function syncAudio() {
      // Crée un buffer avant de récupérer le temps de la vidéo
      audioActif.pause();
      setTimeout(function() {
        catchWhenReady(audioActif, function() {
            var videoTime = player.getCurrentTime();
            var adjustedVideoTime = (videoTime * 1000 + offsetMs) / 1000;
            setTimeout(() => {
		audioSalle1.currentTime = adjustedVideoTime;
            	audioSalle2.currentTime = adjustedVideoTime;
	    }, 600);  // Petit délai pour garantir la mise à jour correcte

	    if (audioActif.paused) {
    		audioActif.play().catch((error) => console.log("Erreur lecture audio:", error));
	    }

	    // Toujours arrêter l'autre audio
            if (audioActif === audioSalle1) {
            	audioSalle2.pause();
            } else {
                audioSalle1.pause();
            }
        });
      }, 200);  // Le buffer avant de récupérer le temps vidéo
    }

    function stopSync() {
        audioActif.pause();
    }

    function syncAudioBouton() {
      setTimeout(function() {
        catchWhenReady(audioActif, function() {
            var videoTime = player.getCurrentTime();
            var adjustedVideoTime = (videoTime * 1000 + offsetMs) / 1000;
            
            setTimeout(() => {
    		audioSalle1.currentTime = adjustedVideoTime;
                audioSalle2.currentTime = adjustedVideoTime;
	    }, 400);  // Petit délai pour garantir la mise à jour correcte

	    if (audioActif.paused) {
    		audioActif.play().catch((error) => console.log("Erreur lecture audio:", error));
            }

	    // Toujours arrêter l'autre audio
            if (audioActif === audioSalle1) {
            	audioSalle2.pause();
            } else {
                audioSalle1.pause();
            }
        });
      }, 200);  // Le buffer avant de récupérer le temps vidéo
    }

    btnBascule.addEventListener("click", function () {
	if (!syncCalled) return; // Empêcher l'exécution si le bouton est désactivé
	audioActif.pause();

	if (audioActif === audioSalle1) {
	            audioActif = audioSalle2;
	            btnBascule.classList.remove("btn-salle1");
	            btnBascule.classList.add("btn-salle2");
	            btnBascule.children[0].textContent = "Off";
	            btnBascule.children[1].textContent = "Audio Salle 2";
	} else {
	            audioActif = audioSalle1;
	            btnBascule.classList.remove("btn-salle2");
	            btnBascule.classList.add("btn-salle1");
	            btnBascule.children[0].textContent = "Audio Salle 1";
	            btnBascule.children[1].textContent = "Off";
	}
	
	if (player.getPlayerState() == YT.PlayerState.PLAYING) {
		syncAudioBouton();
	}
    });

    window.addEventListener("orientationchange", function() {
	    // Attendez un peu pour que l'orientation change soit bien pris en compte
	    setTimeout(function() {
	        catchWhenReady(audioActif, function() {
	            var videoTime = player.getCurrentTime();
	            var adjustedVideoTime = (videoTime * 1000 + offsetMs) / 1000;
	            setTimeout(() => {
			audioSalle1.currentTime = adjustedVideoTime;
	            	audioSalle2.currentTime = adjustedVideoTime;
		    }, 600);  // Petit délai pour garantir la mise à jour correcte
	
		    if (audioActif.paused) {
	    		audioActif.play().catch((error) => console.log("Erreur lecture audio:", error));
		    }
	
		    // Toujours arrêter l'autre audio
	            if (audioActif === audioSalle1) {
	            	audioSalle2.pause();
	            } else {
	                audioSalle1.pause();
	            }
	        });
	    }, 200);  // Attendez 500ms pour garantir la prise en compte du changement
	});

    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
</script>
</body>
</html>
